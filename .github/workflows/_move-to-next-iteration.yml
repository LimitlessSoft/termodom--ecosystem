name: Move to next iteration

# Running this job at 22:01 Sunday will run at 23:01/00:01 Belgrade time on Monday depending on whether Daylight Saving Time (DTS) is in effect.
# We have check-local-time job to ensure it is ran at 00:01 Belgrade time on Monday.
# This is if we use the cron: '1 22-23 * * 0' schedule.

# To save resources, we run this job only at 23:01, which is 00:01/01:01 Belgrade time on Monday.
# With it, we are halving the number of runs per week, however it will not be ran strictly at 00:01 Belgrade time.
# In this scenario, check-local-time job is not needed, however we keep it in case we decide to update cron schedule to the first one.
on:
    workflow_dispatch:
    schedule:
        - cron: '1 23 * * 0' # This will run at 23:01 UTC on Sunday, which is 00:01/01:001 Belgrade time on Monday.
        # - cron: '1 22-23 * * 0' # This will run at 22:01 and 23:01 UTC on Sunday, which is 23:01 Sunday /00:01 Monday Belgrade time, and check-local-time job will ensure it is ran at 00:01 Belgrade time (so second run).

env:
    TZ: Europe/Belgrade
    LOCAL_TIME: '00:01'

jobs:
    check-local-time:
        runs-on: ubuntu-latest
        outputs:
            run: ${{ steps.check_local_time.outputs.run }}
        steps:
            - name: Check local time
              id: check_local_time
              run: |
                  CURRENT=$(TZ=$TZ date +"%H:%M")
                  echo "ðŸ•’ Belgrade local time: $CURRENT"

                  if [ "$CURRENT" == "$LOCAL_TIME" ]; then
                    echo "âœ… It's $LOCAL_TIME in Belgrade. Job will run."
                    echo "run=true" >> $GITHUB_OUTPUT
                  else
                    echo "â± Not $LOCAL_TIME. Job will be skipped."
                    echo "run=false" >> $GITHUB_OUTPUT
                  fi
    move-to-next-iteration:
        name: Move to next iteration
        needs: check-local-time
        if: needs.check-local-time.outputs.run == 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: blombard/move-to-next-iteration@master
              with:
                  owner: LimitlessSoft
                  number: 3
                  token: ${{ secrets.GH_TOKEN }}
                  iteration-field: Iteration
                  iteration: last
                  new-iteration: current
                  excluded-statuses: "Done, Won't Fix"
